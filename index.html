<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Modern Proxy Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
<script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
<style>
    body { background-color: #0f0f0f; color: #e5e5e5; font-family: monospace; }
    .table-row:hover { background-color: #222; cursor: pointer; }
    .badge { padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-weight: bold; color: white; }
    .status-2xx { background-color: #10b981; }  /* green */
    .status-3xx { background-color: #3b82f6; }  /* blue */
    .status-4xx { background-color: #f59e0b; }  /* yellow */
    .status-5xx { background-color: #ef4444; }  /* red */
    pre { white-space: pre-wrap; word-wrap: break-word; }
    #terminal-output { 
        background: #0d0d0d; 
        color: #0f0; 
        padding: 10px; 
        height: 100%; 
        overflow-y: auto; 
        font-family: "Courier New", monospace; 
        font-size: 14px; 
        white-space: pre-wrap; 
        word-break: break-word; 
        line-height: 1.4; 
    }
</style>
</head>
<body class="p-6">

<h1 class="text-3xl font-bold mb-6">ðŸ”¥ RedKit Proxy Dashboard</h1>

<div class="flex gap-4">

    <!-- Sidebar Request List -->
    <div class="w-1/3 bg-[#141414] rounded-xl p-4 shadow h-[80vh] overflow-auto">
        <h2 class="text-xl font-semibold mb-4">Requests</h2>
        <input id="search" placeholder="Search URL..." 
               class="w-full mb-3 p-2 rounded bg-[#1f1f1f]" />

        <table class="w-full text-sm">
            <thead class="text-gray-400 border-b border-gray-700">
                <tr>
                    <th>ID</th>
                    <th>Method</th>
                    <th>Status</th>
                    <th>URL</th>
                </tr>
            </thead>
            <tbody id="traffic"></tbody>
        </table>

        <button id="toggle-refresh" class="mt-3 p-2 w-full bg-gray-700 rounded hover:bg-gray-600">
            Pause Auto-Refresh
        </button>

        <button id="clearRequestsBtn" class="mt-2 p-2 w-full bg-red-600 rounded hover:bg-red-500 text-white">
            Clear Requests
        </button>
    </div>

    <!-- Details Panels -->
    <div class="w-2/3 flex flex-col gap-4">

        <!-- Request Details -->
        <div class="bg-[#141414] rounded-xl p-4 shadow h-1/3 overflow-auto">
            <h2 class="text-xl font-semibold mb-2">Request Details</h2>
            <button onclick="copyContent('requestHeaders')" class="mb-2 p-1 bg-gray-600 rounded hover:bg-gray-500">Copy Headers</button>
            <pre id="requestHeaders" class="mb-2 bg-[#1f1f1f] p-2 rounded"></pre>
            <button onclick="copyContent('requestBody')" class="mb-2 p-1 bg-gray-600 rounded hover:bg-gray-500">Copy Body</button>
            <pre id="requestBody" class="bg-[#1f1f1f] p-2 rounded"></pre>
        </div>

        <!-- Response Details -->
        <div class="bg-[#141414] rounded-xl p-4 shadow h-1/3 overflow-auto">
            <h2 class="text-xl font-semibold mb-2">Response Details</h2>
            <button onclick="copyContent('responseHeaders')" class="mb-2 p-1 bg-gray-600 rounded hover:bg-gray-500">Copy Headers</button>
            <pre id="responseHeaders" class="mb-2 bg-[#1f1f1f] p-2 rounded"></pre>
            <button onclick="copyContent('responseBody')" class="mb-2 p-1 bg-gray-600 rounded hover:bg-gray-500">Copy Body</button>
            <pre id="responseBody" class="bg-[#1f1f1f] p-2 rounded"></pre>
        </div>

        <!-- Terminal Panel -->
        <div class="bg-[#141414] rounded-xl p-4 shadow h-1/3 overflow-auto">
            <h2 class="text-xl font-semibold mb-2">Web Terminal</h2>
            <div id="terminal" style="width:100%; height:100%; background:black; border-radius:8px;"></div>
        </div>

    </div>

</div>

<script>
let autoRefresh = true;
const refreshInterval = 2000;
let intervalId = null;

document.getElementById("toggle-refresh").addEventListener("click", () => {
    autoRefresh = !autoRefresh;
    document.getElementById("toggle-refresh").textContent = autoRefresh ? "Pause Auto-Refresh" : "Resume Auto-Refresh";
    if(autoRefresh) startAutoRefresh(); else stopAutoRefresh();
});

function startAutoRefresh() {
    stopAutoRefresh();
    intervalId = setInterval(loadTraffic, refreshInterval);
}

function stopAutoRefresh() {
    if(intervalId) clearInterval(intervalId);
}

async function loadTraffic() {
    const res = await fetch("/api/traffic");
    const payload = await res.json();
    let rows = payload.data;

    const search = document.getElementById("search").value.toLowerCase();
    if (search.trim() !== "") {
        rows = rows.filter(r => r[2].toLowerCase().includes(search));
    }

    const table = document.getElementById("traffic");
    table.innerHTML = "";

    rows.forEach(row => {
        const tr = document.createElement("tr");
        tr.className = "table-row border-b border-gray-800";

        let statusClass = "";
        if(row[3] >= 200 && row[3] < 300) statusClass = "status-2xx";
        else if(row[3] >= 300 && row[3] < 400) statusClass = "status-3xx";
        else if(row[3] >= 400 && row[3] < 500) statusClass = "status-4xx";
        else if(row[3] >= 500) statusClass = "status-5xx";

        tr.innerHTML = `
            <td class="p-2">${row[0]}</td>
            <td class="p-2">${row[1]}</td>
            <td class="p-2"><span class="badge ${statusClass}">${row[3]}</span></td>
            <td class="p-2">${row[2]}</td>
        `;

        tr.onclick = () => showDetails(row[0]);
        table.appendChild(tr);
    });
}

async function showDetails(id) {
    const reqRes = await fetch("/api/request/" + id);
    const reqData = await reqRes.json();
    document.getElementById("requestHeaders").innerText = JSON.stringify(reqData.data[2], null, 2);
    document.getElementById("requestBody").innerText = JSON.stringify(reqData.data[3], null, 2);

    const resRes = await fetch("/api/response/" + id);
    const resData = await resRes.json();
    document.getElementById("responseHeaders").innerText = JSON.stringify(resData.data[1], null, 2);
    document.getElementById("responseBody").innerText = JSON.stringify(resData.data[2], null, 2);
}

function copyContent(id) {
    const el = document.getElementById(id);
    navigator.clipboard.writeText(el.innerText);
}

document.getElementById("clearRequestsBtn").onclick = async () => {
    if (!confirm("Are you sure you want to clear all saved requests?")) return;
    await fetch("/api/clear-requests", { method: "DELETE" });
    loadTraffic();
};

startAutoRefresh();

// -------- Terminal Setup --------
const term = new Terminal({
    cols: 120,
    rows: 15,
    theme: {
        background: '#000000',
        foreground: '#00ff00'
    }
});
term.open(document.getElementById("terminal"));

const ws = new WebSocket(`ws://${location.host}/ws/terminal`);
term.write("Connected to Web Terminal\n$ ");

let currentCmd = "";
term.onKey(e => {
    const char = e.key;

    if (char === "\r") {
        ws.send(currentCmd);
        currentCmd = "";
        term.write("\n$ ");
    } else if (e.domEvent.key === "Backspace") {
        if (currentCmd.length > 0) {
            currentCmd = currentCmd.slice(0, -1);
            term.write("\b \b");
        }
    } else {
        currentCmd += char;
        term.write(char);
    }
});

ws.onmessage = (event) => {
    term.write("\n" + event.data + "\n$ ");
    term.scrollToBottom(); // Scroll automatically to last line
};
</script>

</body>
</html>
