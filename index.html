<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RedKit Proxy Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
<script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
<style>
    body { background-color: #0f0f0f; color: #e5e5e5; font-family: monospace; }
    .table-row:hover { background-color: #222; cursor: pointer; }
    .badge { padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-weight: bold; color: white; }
    .status-2xx { background-color: #10b981; }
    .status-3xx { background-color: #3b82f6; }
    .status-4xx { background-color: #f59e0b; }
    .status-5xx { background-color: #ef4444; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    .tab-btn { transition: all 0.2s; }
    .tab-btn.active { background-color: #ef4444; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    textarea { resize: vertical; }
    .result-row:hover { background-color: #1a1a1a; }
    .result-row.selected { background-color: #2a2a2a; border-left: 3px solid #ef4444; }
    #terminal-output { 
        background: #0d0d0d; 
        color: #0f0; 
        padding: 10px; 
        height: 100%; 
        overflow-y: auto; 
        font-family: "Courier New", monospace; 
        font-size: 14px; 
        white-space: pre-wrap; 
        word-break: break-word; 
        line-height: 1.4; 
    }
    .loader {
        border: 3px solid #333;
        border-top: 3px solid #ef4444;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    /* Response Tabs */
    .response-tab-btn.active { background-color: #3b82f6 !important; color: white; }
    .response-tab-content { display: none; }
    .response-tab-content.active { display: block; }
    .response-tab-content:not(.hidden) { display: block; }
    /* Syntax Highlighting */
    .json-key { color: #f472b6; }
    .json-string { color: #a5f3fc; }
    .json-number { color: #fde047; }
    .json-boolean { color: #c084fc; }
    .json-null { color: #94a3b8; }
    .xml-tag { color: #f472b6; }
    .xml-attr { color: #a5f3fc; }
    .xml-value { color: #fde047; }
</style>
</head>
<body class="p-6">

<h1 class="text-3xl font-bold mb-4">ðŸ”¥ RedKit Proxy Dashboard</h1>

<!-- Navigation Tabs -->
<div class="flex gap-2 mb-4">
    <button onclick="showTab('proxy')" class="tab-btn active px-4 py-2 rounded bg-gray-700 hover:bg-gray-600" id="tab-proxy">
        ðŸ“¡ Proxy
    </button>
    <button onclick="showTab('repeater')" class="tab-btn px-4 py-2 rounded bg-gray-700 hover:bg-gray-600" id="tab-repeater">
        ðŸ”„ Repeater
    </button>
    <button onclick="showTab('intruder')" class="tab-btn px-4 py-2 rounded bg-gray-700 hover:bg-gray-600" id="tab-intruder">
        ðŸ’¥ Intruder
    </button>
    <button onclick="showTab('terminal')" class="tab-btn px-4 py-2 rounded bg-gray-700 hover:bg-gray-600" id="tab-terminal">
        ðŸ’» Terminal
    </button>
</div>

<!-- ==================== PROXY TAB ==================== -->
<div id="content-proxy" class="tab-content active">
    <div class="flex gap-4">
        <!-- Sidebar Request List -->
        <div class="w-1/3 bg-[#141414] rounded-xl p-4 shadow h-[75vh] overflow-auto">
            <h2 class="text-xl font-semibold mb-4">Requests</h2>
            <input id="search" placeholder="Search URL..." 
                   class="w-full mb-3 p-2 rounded bg-[#1f1f1f]" />

            <table class="w-full text-sm">
                <thead class="text-gray-400 border-b border-gray-700">
                    <tr>
                        <th>ID</th>
                        <th>Method</th>
                        <th>Status</th>
                        <th>URL</th>
                    </tr>
                </thead>
                <tbody id="traffic"></tbody>
            </table>

            <button id="toggle-refresh" class="mt-3 p-2 w-full bg-gray-700 rounded hover:bg-gray-600">
                Pause Auto-Refresh
            </button>

            <button id="clearRequestsBtn" class="mt-2 p-2 w-full bg-red-600 rounded hover:bg-red-500 text-white">
                Clear Requests
            </button>
        </div>

        <!-- Details Panels -->
        <div class="w-2/3 flex flex-col gap-4">
            <!-- Request Details -->
            <div class="bg-[#141414] rounded-xl p-4 shadow h-1/2 overflow-auto">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold">Request Details</h2>
                    <button onclick="sendToRepeater()" class="px-3 py-1 bg-blue-600 rounded hover:bg-blue-500 text-sm">
                        Send to Repeater â†’
                    </button>
                </div>
                <button onclick="copyContent('requestHeaders')" class="mb-2 p-1 bg-gray-600 rounded hover:bg-gray-500">Copy Headers</button>
                <pre id="requestHeaders" class="mb-2 bg-[#1f1f1f] p-2 rounded max-h-32 overflow-auto"></pre>
                <button onclick="copyContent('requestBody')" class="mb-2 p-1 bg-gray-600 rounded hover:bg-gray-500">Copy Body</button>
                <pre id="requestBody" class="bg-[#1f1f1f] p-2 rounded max-h-32 overflow-auto"></pre>
            </div>

            <!-- Response Details -->
            <div class="bg-[#141414] rounded-xl p-4 shadow h-1/2 overflow-auto">
                <h2 class="text-xl font-semibold mb-2">Response Details</h2>
                <button onclick="copyContent('responseHeaders')" class="mb-2 p-1 bg-gray-600 rounded hover:bg-gray-500">Copy Headers</button>
                <pre id="responseHeaders" class="mb-2 bg-[#1f1f1f] p-2 rounded max-h-32 overflow-auto"></pre>
                <button onclick="copyContent('responseBody')" class="mb-2 p-1 bg-gray-600 rounded hover:bg-gray-500">Copy Body</button>
                <pre id="responseBody" class="bg-[#1f1f1f] p-2 rounded max-h-32 overflow-auto"></pre>
            </div>
        </div>
    </div>
</div>

<!-- ==================== REPEATER TAB ==================== -->
<div id="content-repeater" class="tab-content">
    <div class="flex gap-4 h-[75vh]">
        <!-- Request Editor -->
        <div class="w-1/2 bg-[#141414] rounded-xl p-4 shadow flex flex-col">
            <h2 class="text-xl font-semibold mb-3">Request</h2>
            
            <div class="flex gap-2 mb-3">
                <select id="repeater-method" class="p-2 rounded bg-[#1f1f1f] w-24">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                    <option value="PATCH">PATCH</option>
                    <option value="HEAD">HEAD</option>
                    <option value="OPTIONS">OPTIONS</option>
                </select>
                <input id="repeater-url" placeholder="https://example.com/api/endpoint" 
                       class="flex-1 p-2 rounded bg-[#1f1f1f]" />
            </div>

            <label class="text-gray-400 text-sm mb-1">Headers (JSON)</label>
            <textarea id="repeater-headers" class="p-2 rounded bg-[#1f1f1f] h-24 mb-3 font-mono text-sm">{
  "Content-Type": "application/json",
  "User-Agent": "RedKit/1.0"
}</textarea>

            <label class="text-gray-400 text-sm mb-1">Body</label>
            <textarea id="repeater-body" class="p-2 rounded bg-[#1f1f1f] flex-1 font-mono text-sm" placeholder="Request body..."></textarea>

            <div class="flex gap-2 mt-3">
                <button onclick="sendRepeaterRequest()" class="flex-1 p-2 bg-green-600 rounded hover:bg-green-500 font-bold">
                    ðŸš€ Send
                </button>
                <button onclick="clearRepeater()" class="p-2 bg-gray-600 rounded hover:bg-gray-500">
                    Clear
                </button>
            </div>
        </div>

        <!-- Response Viewer -->
        <div class="w-1/2 bg-[#141414] rounded-xl p-4 shadow flex flex-col">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold">Response</h2>
                <div id="repeater-status" class="text-sm"></div>
            </div>

            <div id="repeater-info" class="flex gap-4 mb-3 text-sm text-gray-400">
                <span>Status: <span id="repeater-status-code" class="text-white">-</span></span>
                <span>Time: <span id="repeater-time" class="text-white">-</span></span>
                <span>Size: <span id="repeater-size" class="text-white">-</span></span>
            </div>

            <!-- Response Tabs -->
            <div class="flex gap-1 mb-3">
                <button onclick="showResponseTab('headers')" class="response-tab-btn active px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600" id="resp-tab-headers">
                    Headers
                </button>
                <button onclick="showResponseTab('raw')" class="response-tab-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600" id="resp-tab-raw">
                    Raw
                </button>
                <button onclick="showResponseTab('pretty')" class="response-tab-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600" id="resp-tab-pretty">
                    Pretty
                </button>
                <button onclick="showResponseTab('render')" class="response-tab-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600" id="resp-tab-render">
                    Render
                </button>
                <button onclick="showResponseTab('hex')" class="response-tab-btn px-3 py-1 rounded text-sm bg-gray-700 hover:bg-gray-600" id="resp-tab-hex">
                    Hex
                </button>
            </div>

            <!-- Headers Tab -->
            <div id="response-content-headers" class="response-tab-content flex-1 overflow-auto">
                <pre id="repeater-response-headers" class="p-2 rounded bg-[#1f1f1f] h-full overflow-auto text-sm"></pre>
            </div>

            <!-- Raw Tab -->
            <div id="response-content-raw" class="response-tab-content flex-1 overflow-auto hidden">
                <pre id="repeater-response-body" class="p-2 rounded bg-[#1f1f1f] h-full overflow-auto text-sm font-mono"></pre>
            </div>

            <!-- Pretty Tab (formatted JSON/XML) -->
            <div id="response-content-pretty" class="response-tab-content flex-1 overflow-auto hidden">
                <pre id="repeater-response-pretty" class="p-2 rounded bg-[#1f1f1f] h-full overflow-auto text-sm font-mono"></pre>
            </div>

            <!-- Render Tab (HTML preview) -->
            <div id="response-content-render" class="response-tab-content flex-1 overflow-auto hidden">
                <iframe id="repeater-response-render" class="w-full h-full rounded bg-white" sandbox="allow-same-origin"></iframe>
            </div>

            <!-- Hex Tab -->
            <div id="response-content-hex" class="response-tab-content flex-1 overflow-auto hidden">
                <pre id="repeater-response-hex" class="p-2 rounded bg-[#1f1f1f] h-full overflow-auto text-sm font-mono text-green-400"></pre>
            </div>

            <div class="flex gap-2 mt-3">
                <button onclick="copyContent('repeater-response-body')" class="p-2 bg-gray-600 rounded hover:bg-gray-500">
                    Copy Body
                </button>
                <button onclick="sendToIntruder()" class="p-2 bg-purple-600 rounded hover:bg-purple-500">
                    Send to Intruder â†’
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== INTRUDER TAB ==================== -->
<div id="content-intruder" class="tab-content">
    <div class="flex gap-4 h-[75vh]">
        <!-- Attack Config -->
        <div class="w-1/3 bg-[#141414] rounded-xl p-4 shadow flex flex-col overflow-auto">
            <h2 class="text-xl font-semibold mb-3">Attack Configuration</h2>

            <label class="text-gray-400 text-sm mb-1">Attack Type</label>
            <select id="intruder-attack-type" class="p-2 rounded bg-[#1f1f1f] mb-3">
                <option value="sniper">Sniper - Single position at a time</option>
                <option value="battering_ram">Battering Ram - Same payload everywhere</option>
                <option value="pitchfork">Pitchfork - Parallel payloads</option>
                <option value="cluster_bomb">Cluster Bomb - All combinations</option>
            </select>

            <label class="text-gray-400 text-sm mb-1">Method</label>
            <select id="intruder-method" class="p-2 rounded bg-[#1f1f1f] mb-3 w-full">
                <option value="GET">GET</option>
                <option value="POST">POST</option>
                <option value="PUT">PUT</option>
                <option value="DELETE">DELETE</option>
            </select>

            <label class="text-gray-400 text-sm mb-1">Target URL (use Â§ for positions)</label>
            <input id="intruder-url" placeholder="https://target.com/user/Â§1Â§" 
                   class="p-2 rounded bg-[#1f1f1f] mb-3" />

            <label class="text-gray-400 text-sm mb-1">Headers (JSON)</label>
            <textarea id="intruder-headers" class="p-2 rounded bg-[#1f1f1f] h-20 mb-3 font-mono text-sm">{}</textarea>

            <label class="text-gray-400 text-sm mb-1">Body (use Â§ for positions)</label>
            <textarea id="intruder-body" class="p-2 rounded bg-[#1f1f1f] h-20 mb-3 font-mono text-sm" 
                      placeholder="username=Â§adminÂ§&password=Â§passÂ§"></textarea>

            <label class="text-gray-400 text-sm mb-1">Payloads (one per line)</label>
            <textarea id="intruder-payloads" class="p-2 rounded bg-[#1f1f1f] flex-1 font-mono text-sm" 
                      placeholder="admin&#10;root&#10;user&#10;test"></textarea>

            <div class="flex gap-2 mt-3">
                <select id="intruder-preset" class="p-2 rounded bg-[#1f1f1f] flex-1" onchange="loadPayloadPreset()">
                    <option value="">Load Preset...</option>
                    <option value="passwords">Common Passwords</option>
                    <option value="usernames">Common Usernames</option>
                    <option value="sqli">SQL Injection</option>
                    <option value="xss">XSS Payloads</option>
                    <option value="path_traversal">Path Traversal</option>
                </select>
                <input id="intruder-threads" type="number" value="10" min="1" max="50" 
                       class="p-2 rounded bg-[#1f1f1f] w-20" title="Threads" />
            </div>

            <div class="flex gap-2 mt-3">
                <button onclick="startIntruderAttack()" id="intruder-start-btn" 
                        class="flex-1 p-2 bg-red-600 rounded hover:bg-red-500 font-bold">
                    ðŸš€ Start Attack
                </button>
                <button onclick="stopIntruderAttack()" class="p-2 bg-gray-600 rounded hover:bg-gray-500">
                    Stop
                </button>
            </div>
        </div>

        <!-- Results -->
        <div class="w-2/3 bg-[#141414] rounded-xl p-4 shadow flex flex-col">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold">Results</h2>
                <div id="intruder-progress" class="text-sm text-gray-400"></div>
            </div>

            <!-- Results Table -->
            <div class="flex-1 overflow-auto mb-3">
                <table class="w-full text-sm">
                    <thead class="text-gray-400 border-b border-gray-700 sticky top-0 bg-[#141414]">
                        <tr>
                            <th class="p-2 text-left">#</th>
                            <th class="p-2 text-left">Payload</th>
                            <th class="p-2 text-left">Status</th>
                            <th class="p-2 text-left">Length</th>
                            <th class="p-2 text-left">Time</th>
                        </tr>
                    </thead>
                    <tbody id="intruder-results"></tbody>
                </table>
            </div>

            <!-- Result Detail -->
            <div class="bg-[#1f1f1f] rounded p-3">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-400 text-sm">Response Preview</span>
                    <button onclick="copyContent('intruder-response-preview')" class="text-xs p-1 bg-gray-600 rounded">Copy</button>
                </div>
                <pre id="intruder-response-preview" class="text-sm max-h-40 overflow-auto"></pre>
            </div>

            <!-- Summary -->
            <div id="intruder-summary" class="mt-3 p-3 bg-[#1f1f1f] rounded text-sm hidden">
                <span class="font-bold">Summary:</span>
                <span id="intruder-summary-text"></span>
            </div>
        </div>
    </div>
</div>

<!-- ==================== TERMINAL TAB ==================== -->
<div id="content-terminal" class="tab-content">
    <div class="bg-[#141414] rounded-xl p-4 shadow h-[75vh]">
        <h2 class="text-xl font-semibold mb-3">Web Terminal</h2>
        <div id="terminal" style="width:100%; height:calc(100% - 40px); background:black; border-radius:8px;"></div>
    </div>
</div>

<script>
// ==================== TAB NAVIGATION ====================
function showTab(tabName) {
    // Hide all content
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    
    // Show selected
    document.getElementById('content-' + tabName).classList.add('active');
    document.getElementById('tab-' + tabName).classList.add('active');
    
    // Initialize terminal if needed
    if (tabName === 'terminal' && !terminalInitialized) {
        initTerminal();
    }
}

// ==================== PROXY TAB ====================
let autoRefresh = true;
const refreshInterval = 2000;
let intervalId = null;
let currentRequestId = null;
let currentRequestData = null;

document.getElementById("toggle-refresh").addEventListener("click", () => {
    autoRefresh = !autoRefresh;
    document.getElementById("toggle-refresh").textContent = autoRefresh ? "Pause Auto-Refresh" : "Resume Auto-Refresh";
    if(autoRefresh) startAutoRefresh(); else stopAutoRefresh();
});

function startAutoRefresh() {
    stopAutoRefresh();
    intervalId = setInterval(loadTraffic, refreshInterval);
}

function stopAutoRefresh() {
    if(intervalId) clearInterval(intervalId);
}

async function loadTraffic() {
    try {
        const res = await fetch("/api/traffic");
        const payload = await res.json();
        let rows = payload.data;

        const search = document.getElementById("search").value.toLowerCase();
        if (search.trim() !== "") {
            rows = rows.filter(r => r[2].toLowerCase().includes(search));
        }

        const table = document.getElementById("traffic");
        table.innerHTML = "";

        rows.forEach(row => {
            const tr = document.createElement("tr");
            tr.className = "table-row border-b border-gray-800";

            let statusClass = "";
            if(row[3] >= 200 && row[3] < 300) statusClass = "status-2xx";
            else if(row[3] >= 300 && row[3] < 400) statusClass = "status-3xx";
            else if(row[3] >= 400 && row[3] < 500) statusClass = "status-4xx";
            else if(row[3] >= 500) statusClass = "status-5xx";

            tr.innerHTML = `
                <td class="p-2">${row[0]}</td>
                <td class="p-2">${row[1]}</td>
                <td class="p-2"><span class="badge ${statusClass}">${row[3]}</span></td>
                <td class="p-2 truncate max-w-xs">${row[2]}</td>
            `;

            tr.onclick = () => showDetails(row[0]);
            table.appendChild(tr);
        });
    } catch (e) {
        console.error("Failed to load traffic:", e);
    }
}

async function showDetails(id) {
    currentRequestId = id;
    
    const reqRes = await fetch("/api/request/" + id);
    const reqData = await reqRes.json();
    currentRequestData = reqData.data;
    
    document.getElementById("requestHeaders").innerText = reqData.data[2] || "{}";
    document.getElementById("requestBody").innerText = reqData.data[3] || "";

    const resRes = await fetch("/api/response/" + id);
    const resData = await resRes.json();
    document.getElementById("responseHeaders").innerText = resData.data[1] || "{}";
    document.getElementById("responseBody").innerText = resData.data[2] || "";
}

function copyContent(id) {
    const el = document.getElementById(id);
    navigator.clipboard.writeText(el.innerText);
}

document.getElementById("clearRequestsBtn").onclick = async () => {
    if (!confirm("Are you sure you want to clear all saved requests?")) return;
    await fetch("/api/clear-requests", { method: "DELETE" });
    loadTraffic();
};

startAutoRefresh();

// ==================== REPEATER TAB ====================
function sendToRepeater() {
    if (!currentRequestData) {
        alert("Select a request first!");
        return;
    }
    
    showTab('repeater');
    
    // Fill repeater form
    document.getElementById("repeater-method").value = currentRequestData[0] || "GET";
    document.getElementById("repeater-url").value = currentRequestData[1] || "";
    document.getElementById("repeater-headers").value = currentRequestData[2] || "{}";
    document.getElementById("repeater-body").value = currentRequestData[3] || "";
}

async function sendRepeaterRequest() {
    const method = document.getElementById("repeater-method").value;
    const url = document.getElementById("repeater-url").value;
    let headers = {};
    
    try {
        headers = JSON.parse(document.getElementById("repeater-headers").value);
    } catch (e) {
        alert("Invalid headers JSON!");
        return;
    }
    
    const body = document.getElementById("repeater-body").value;
    
    document.getElementById("repeater-status").innerHTML = '<span class="loader"></span> Sending...';
    
    try {
        const res = await fetch("/api/repeater/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ method, url, headers, body })
        });
        
        const data = await res.json();
        
        if (data.success) {
            document.getElementById("repeater-status").innerHTML = '<span class="text-green-500">âœ“ Success</span>';
            document.getElementById("repeater-status-code").innerText = data.data.status_code;
            document.getElementById("repeater-time").innerText = data.data.elapsed_time + "s";
            document.getElementById("repeater-size").innerText = data.data.size + " bytes";
            
            // Update all response tabs
            updateResponseTabs(data.data.headers, data.data.body);
        } else {
            document.getElementById("repeater-status").innerHTML = '<span class="text-red-500">âœ— Error: ' + data.data.error + '</span>';
        }
    } catch (e) {
        document.getElementById("repeater-status").innerHTML = '<span class="text-red-500">âœ— Request failed: ' + e.message + '</span>';
        console.error("Repeater error:", e);
    }
}

function clearRepeater() {
    document.getElementById("repeater-url").value = "";
    document.getElementById("repeater-headers").value = '{\n  "Content-Type": "application/json"\n}';
    document.getElementById("repeater-body").value = "";
    document.getElementById("repeater-response-headers").innerText = "";
    document.getElementById("repeater-response-body").innerText = "";
    document.getElementById("repeater-response-pretty").innerHTML = "";
    document.getElementById("repeater-response-hex").innerText = "";
    document.getElementById("repeater-response-render").srcdoc = "";
    document.getElementById("repeater-status-code").innerText = "-";
    document.getElementById("repeater-time").innerText = "-";
    document.getElementById("repeater-size").innerText = "-";
}

function sendToIntruder() {
    showTab('intruder');
    document.getElementById("intruder-method").value = document.getElementById("repeater-method").value;
    document.getElementById("intruder-url").value = document.getElementById("repeater-url").value;
    document.getElementById("intruder-headers").value = document.getElementById("repeater-headers").value;
    document.getElementById("intruder-body").value = document.getElementById("repeater-body").value;
}

// ==================== INTRUDER TAB ====================
let intruderResults = [];

async function loadPayloadPreset() {
    const preset = document.getElementById("intruder-preset").value;
    if (!preset) return;
    
    try {
        const res = await fetch("/api/intruder/payloads/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ payload_type: preset })
        });
        
        const data = await res.json();
        document.getElementById("intruder-payloads").value = data.payloads.join("\n");
        document.getElementById("intruder-preset").value = "";
    } catch (e) {
        alert("Failed to load payloads");
    }
}

async function startIntruderAttack() {
    const attackType = document.getElementById("intruder-attack-type").value;
    const method = document.getElementById("intruder-method").value;
    const url = document.getElementById("intruder-url").value;
    const body = document.getElementById("intruder-body").value;
    const threads = parseInt(document.getElementById("intruder-threads").value) || 10;
    
    let headers = {};
    try {
        headers = JSON.parse(document.getElementById("intruder-headers").value);
    } catch (e) {
        alert("Invalid headers JSON!");
        return;
    }
    
    const payloadsText = document.getElementById("intruder-payloads").value;
    const payloads = payloadsText.split("\n").filter(p => p.trim());
    
    if (payloads.length === 0) {
        alert("Please enter payloads!");
        return;
    }
    
    // Clear previous results
    document.getElementById("intruder-results").innerHTML = "";
    document.getElementById("intruder-response-preview").innerText = "";
    document.getElementById("intruder-summary").classList.add("hidden");
    intruderResults = [];
    
    document.getElementById("intruder-start-btn").disabled = true;
    document.getElementById("intruder-start-btn").innerText = "â³ Running...";
    document.getElementById("intruder-progress").innerText = "Starting attack...";
    
    try {
        const res = await fetch("/api/intruder/attack", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                method,
                url,
                headers,
                body,
                attack_type: attackType,
                payloads,
                threads
            })
        });
        
        const data = await res.json();
        intruderResults = data.results;
        
        // Display results
        const tbody = document.getElementById("intruder-results");
        data.results.forEach((r, i) => {
            const tr = document.createElement("tr");
            tr.className = "result-row border-b border-gray-800 cursor-pointer";
            
            let statusClass = "";
            if(r.status_code >= 200 && r.status_code < 300) statusClass = "status-2xx";
            else if(r.status_code >= 300 && r.status_code < 400) statusClass = "status-3xx";
            else if(r.status_code >= 400 && r.status_code < 500) statusClass = "status-4xx";
            else if(r.status_code >= 500) statusClass = "status-5xx";
            
            tr.innerHTML = `
                <td class="p-2">${i + 1}</td>
                <td class="p-2 truncate max-w-xs">${r.payload}</td>
                <td class="p-2"><span class="badge ${statusClass}">${r.status_code || 'ERR'}</span></td>
                <td class="p-2">${r.length}</td>
                <td class="p-2">${r.time}s</td>
            `;
            
            tr.onclick = () => showIntruderResult(i, tr);
            tbody.appendChild(tr);
        });
        
        // Show summary
        document.getElementById("intruder-progress").innerText = `Completed: ${data.total_requests} requests`;
        document.getElementById("intruder-summary").classList.remove("hidden");
        
        const summary = data.summary;
        let summaryText = `Total: ${summary.total_requests} | `;
        summaryText += `Errors: ${summary.errors} | `;
        summaryText += `Avg Length: ${Math.round(summary.avg_length)} bytes | `;
        summaryText += `Avg Time: ${summary.avg_time?.toFixed(3)}s`;
        document.getElementById("intruder-summary-text").innerText = summaryText;
        
    } catch (e) {
        document.getElementById("intruder-progress").innerText = "Attack failed: " + e.message;
    }
    
    document.getElementById("intruder-start-btn").disabled = false;
    document.getElementById("intruder-start-btn").innerText = "ðŸš€ Start Attack";
}

async function showIntruderResult(index, row) {
    // Highlight selected row
    document.querySelectorAll('.result-row').forEach(r => r.classList.remove('selected'));
    row.classList.add('selected');
    
    try {
        const res = await fetch("/api/intruder/result/" + index);
        const data = await res.json();
        document.getElementById("intruder-response-preview").innerText = data.response_body || data.error || "No response";
    } catch (e) {
        document.getElementById("intruder-response-preview").innerText = "Failed to load response";
    }
}

async function stopIntruderAttack() {
    try {
        await fetch("/api/intruder/stop", { method: "POST" });
        document.getElementById("intruder-progress").innerText = "Attack stopped";
    } catch (e) {
        console.error("Failed to stop attack");
    }
}

// ==================== TERMINAL ====================
let terminalInitialized = false;
let term = null;
let ws = null;

function initTerminal() {
    if (terminalInitialized) return;
    
    term = new Terminal({
        cols: 120,
        rows: 20,
        theme: {
            background: '#000000',
            foreground: '#00ff00'
        }
    });
    term.open(document.getElementById("terminal"));

    ws = new WebSocket(`ws://${location.host}/ws/terminal`);
    term.write("Connecting to terminal...\r\n");

    let currentCmd = "";
    
    ws.onopen = () => {
        term.write("Connected!\r\n$ ");
    };
    
    term.onKey(e => {
        const char = e.key;

        if (char === "\r") {
            ws.send(currentCmd);
            currentCmd = "";
            term.write("\r\n");
        } else if (e.domEvent.key === "Backspace") {
            if (currentCmd.length > 0) {
                currentCmd = currentCmd.slice(0, -1);
                term.write("\b \b");
            }
        } else {
            currentCmd += char;
            term.write(char);
        }
    });

    ws.onmessage = (event) => {
        term.write(event.data + "\r\n$ ");
        term.scrollToBottom();
    };
    
    ws.onerror = () => {
        term.write("\r\n[Connection error]\r\n");
    };
    
    ws.onclose = () => {
        term.write("\r\n[Disconnected]\r\n");
    };
    
    terminalInitialized = true;
}

// ==================== RESPONSE TABS ====================
let currentResponseBody = "";

function showResponseTab(tabName) {
    // Hide all response content
    document.querySelectorAll('.response-tab-content').forEach(el => {
        el.classList.add('hidden');
        el.classList.remove('active');
    });
    document.querySelectorAll('.response-tab-btn').forEach(el => el.classList.remove('active'));
    
    // Show selected
    const content = document.getElementById('response-content-' + tabName);
    if (content) {
        content.classList.remove('hidden');
        content.classList.add('active');
    }
    document.getElementById('resp-tab-' + tabName).classList.add('active');
}

function updateResponseTabs(headers, body) {
    currentResponseBody = body;
    
    // Headers tab
    document.getElementById("repeater-response-headers").innerText = JSON.stringify(headers, null, 2);
    
    // Raw tab
    document.getElementById("repeater-response-body").innerText = body;
    
    // Pretty tab (formatted JSON/XML/HTML)
    document.getElementById("repeater-response-pretty").innerHTML = formatPretty(body, headers);
    
    // Render tab (HTML preview in iframe)
    const iframe = document.getElementById("repeater-response-render");
    iframe.srcdoc = body;
    
    // Hex tab
    document.getElementById("repeater-response-hex").innerText = toHexView(body);
}

function formatPretty(body, headers) {
    const contentType = headers['content-type'] || headers['Content-Type'] || '';
    
    // Try JSON
    if (contentType.includes('json') || body.trim().startsWith('{') || body.trim().startsWith('[')) {
        try {
            const obj = JSON.parse(body);
            return syntaxHighlightJSON(JSON.stringify(obj, null, 2));
        } catch (e) {
            // Not valid JSON
        }
    }
    
    // Try XML/HTML
    if (contentType.includes('xml') || contentType.includes('html') || body.trim().startsWith('<')) {
        return syntaxHighlightXML(formatXML(body));
    }
    
    // Plain text
    return escapeHtml(body);
}

function syntaxHighlightJSON(json) {
    json = escapeHtml(json);
    return json.replace(/("[^"]+"):/g, '<span class="json-key">$1</span>:')
               .replace(/: ("[^"]*")/g, ': <span class="json-string">$1</span>')
               .replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
               .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
               .replace(/: (null)/g, ': <span class="json-null">$1</span>');
}

function syntaxHighlightXML(xml) {
    xml = escapeHtml(xml);
    return xml.replace(/(&lt;\/?)(\w+)/g, '$1<span class="xml-tag">$2</span>')
              .replace(/(\w+)=("[^"]*")/g, '<span class="xml-attr">$1</span>=<span class="xml-value">$2</span>');
}

function formatXML(xml) {
    let formatted = '';
    let indent = '';
    const tab = '  ';
    
    xml.split(/(<[^>]+>)/g).forEach(node => {
        if (node.match(/^<\/\w/)) {
            indent = indent.substring(tab.length);
        }
        formatted += indent + node + '\n';
        if (node.match(/^<\w[^>]*[^\/]>$/)) {
            indent += tab;
        }
    });
    
    return formatted.trim();
}

function toHexView(str) {
    let hex = '';
    let ascii = '';
    let result = '';
    let offset = 0;
    
    for (let i = 0; i < str.length; i++) {
        const code = str.charCodeAt(i);
        hex += code.toString(16).padStart(2, '0') + ' ';
        ascii += (code >= 32 && code <= 126) ? str[i] : '.';
        
        if ((i + 1) % 16 === 0) {
            result += offset.toString(16).padStart(8, '0') + '  ' + hex + ' |' + ascii + '|\n';
            hex = '';
            ascii = '';
            offset += 16;
        }
    }
    
    // Last line
    if (hex) {
        result += offset.toString(16).padStart(8, '0') + '  ' + hex.padEnd(48, ' ') + ' |' + ascii + '|\n';
    }
    
    return result;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize on page load
loadTraffic();
showResponseTab('headers');
</script>

</body>
</html>
